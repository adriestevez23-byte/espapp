#!/bin/bash
#
# ğŸš€ ESPAPP - Gestor de Sensores ESP32 - Script de inicio universal
# 
# Uso: 
#   ./start                   Ejecuta aplicaciÃ³n GUI
#   ./start build-windows     Construir para Windows
#   ./start build-linux       Construir para Linux
#   ./start build-all         Construir todo
#   ./start help              Ver ayuda
#

set -e

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # Sin color

# Paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
VENV_DIR="$SCRIPT_DIR/bin"

# FunciÃ³n para barra de progreso
progress_bar() {
    local current=$1
    local total=$2
    local label=$3
    local width=30
    
    local percent=$((current * 100 / total))
    local filled=$((width * current / total))
    local empty=$((width - filled))
    
    printf "\r${CYAN}[%-${width}s] %3d%% %s${NC}" "$(printf '#%.0s' $(seq 1 $filled))" "$percent" "$label"
    
    if [ $current -eq $total ]; then
        echo ""
    fi
}

# FunciÃ³n para espera con animaciÃ³n
wait_with_spinner() {
    local duration=$1
    local message=$2
    local spinner=( 'â ‹' 'â ™' 'â ¹' 'â ¸' 'â ¼' 'â ´' 'â ¦' 'â §' 'â ‡' 'â ' )
    
    for ((i = 0; i < duration; i++)); do
        echo -ne "\r${YELLOW}${spinner[$((i % 10))]} ${message}${NC}"
        sleep 0.5
    done
    echo -e "\r${GREEN}âœ… ${message}${NC}           "
}

# FunciÃ³n para mostrar error
error() {
    echo -e "${RED}âŒ $1${NC}" >&2
    exit 1
}

# FunciÃ³n para mostrar Ã©xito
success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

# FunciÃ³n para mostrar info
info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# FunciÃ³n para mostrar advertencia
warn() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

# Verificar que estamos en el directorio correcto
if [ ! -f "main.py" ]; then
    error "Ejecuta este script desde el directorio raÃ­z de la aplicaciÃ³n"
fi

# Activar entorno virtual
activate_venv() {
    if [ ! -d "bin" ]; then
        error "Entorno virtual no encontrado. Ejecuta: python3 -m venv . --system-site-packages"
    fi
    
    echo -n "Activando entorno virtual... "
    source "$VENV_DIR/activate" || error "No se pudo activar el entorno virtual"
    echo -e "${GREEN}âœ…${NC}"
}

# Ejecutar aplicaciÃ³n GUI
run_gui() {
    clear
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘    ğŸš€ Iniciando ESP32 Gestor de Sensores             â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    progress_bar 1 3 "Verificando entorno"
    sleep 0.5
    activate_venv
    
    progress_bar 2 3 "Cargando configuraciÃ³n"
    sleep 0.5
    
    progress_bar 3 3 "Iniciando aplicaciÃ³n"
    echo ""
    echo ""
    python main.py
}

# Construir para Windows
build_windows() {
    clear
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘    ğŸ’¾ Construyendo para Windows                        â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    activate_venv
    
    progress_bar 1 2 "Verificando PyInstaller"
    sleep 0.3
    
    if ! python -c "import PyInstaller" 2>/dev/null; then
        progress_bar 2 2 "Instalando PyInstaller"
        sleep 0.5
        pip install pyinstaller > /dev/null 2>&1
    else
        progress_bar 2 2 "PyInstaller listo"
    fi
    echo ""
    
    wait_with_spinner 2 "Iniciando compilaciÃ³n"
    python scripts/build_windows.py
    success "ConstrucciÃ³n Windows completada âœ¨"
}

# Construir para Linux
build_linux() {
    clear
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘    ğŸ§ Construyendo para Linux                          â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    if [ ! -f "scripts/build_deb.sh" ]; then
        error "scripts/build_deb.sh no encontrado"
    fi
    
    wait_with_spinner 1 "Iniciando compilaciÃ³n"
    bash scripts/build_deb.sh
    success "ConstrucciÃ³n Linux completada âœ¨"
}

# Construir todo
build_all() {
    clear
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘    ğŸ“¦ CompilaciÃ³n completa (Windows + Linux)           â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    progress_bar 0 2 "Construyendo para Windows"
    build_windows
    
    echo ""
    progress_bar 1 2 "Construyendo para Linux"
    build_linux
    
    echo ""
    echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${GREEN}â•‘    âœ… Â¡CompilaciÃ³n completada exitosamente!           â•‘${NC}"
    echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Mostrar ayuda
show_help() {
    cat << 'EOF'

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘            ğŸš€ ESPAPP - Gestor de Sensores ESP32               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USO:
  ./start [OPCIÃ“N]

OPCIONES:
  (sin opciÃ³n)     Ejecutar aplicaciÃ³n GUI ğŸ–¥ï¸
  build-windows    Construir para Windows 10 ğŸ’¾
  build-linux      Construir para Linux .deb ğŸ§
  build-all        Construir todo (Windows + Linux) ğŸ“¦
  help             Mostrar esta ayuda ğŸ“–

EJEMPLOS:

  1. Iniciar aplicaciÃ³n:
     ./start

  2. Construir instalador para Windows:
     ./start build-windows

  3. Construir todo:
     ./start build-all

INFORMACIÃ“N:

  â€¢ AplicaciÃ³n GUI:   Interfaz nativa del sistema
  â€¢ Presiona Ctrl+C o cierra la ventana para detener

REQUISITOS:

  â€¢ Python 3.8+
  â€¢ pip
  â€¢ Dependencias: pip install -r requirements.txt

DOCUMENTACIÃ“N:

  â€¢ GuÃ­a rÃ¡pida:     cat docs/QUICKSTART.md
  â€¢ GuÃ­a completa:   cat docs/README_COMPLETO.md
  â€¢ VerificaciÃ³n empaquetadores: Ver docs/VERIFICACION_EMPAQUETADORES.md

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

EOF
}

# Mostrar menÃº si no hay argumentos
if [ $# -eq 0 ]; then
    clear
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘     ğŸš€ ESPAPP - Gestor de Sensores ESP32               â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${CYAN}Selecciona una opciÃ³n:${NC}"
    echo ""
    echo -e "  ${GREEN}1${NC}) ğŸ–¥ï¸  AplicaciÃ³n GUI"
    echo -e "  ${GREEN}2${NC}) ğŸ’¾ Construir para Windows"
    echo -e "  ${GREEN}3${NC}) ğŸ§ Construir para Linux"
    echo -e "  ${GREEN}4${NC}) ğŸ“¦ Construir todo"
    echo -e "  ${GREEN}5${NC}) ğŸ“– Ayuda"
    echo ""
    read -p "$(echo -e ${CYAN}Selecciona \(1-5\):${NC}) " choice
    
    case $choice in
        1) run_gui ;;
        2) build_windows ;;
        3) build_linux ;;
        4) build_all ;;
        5) show_help ;;
        *) error "OpciÃ³n invÃ¡lida" ;;
    esac
else
    case "$1" in
        web) run_gui ;;
        build-windows) build_windows ;;
        build-linux) build_linux ;;
        build-all) build_all ;;
        help) show_help ;;
        *)
            error "OpciÃ³n desconocida: $1. Usa './start help' para ver opciones"
            ;;
    esac
fi
