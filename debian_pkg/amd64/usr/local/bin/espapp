#!/bin/bash
set -e

# ============================================================================
# Lanzador ESPAPP - Se ejecuta al instalar el paquete
# Detecta/crea entorno virtual y lanza la aplicaci√≥n
# ============================================================================

APP_DIR="/opt/espapp"
VENV_DIR="/opt/espapp/.venv"
PYTHON_VENV="$VENV_DIR/bin/python3"
PIP_VENV="$VENV_DIR/bin/pip"
MAIN_PY="$APP_DIR/main.py"

if [ ! -f "$APP_DIR/main.py" ]; then
    echo "‚ùå Error: main.py no encontrado en $APP_DIR"
    exit 1
fi

# -------------------------------------------------
# Diagn√≥stico r√°pido: comprobar dependencias visibles
# -------------------------------------------------
check_deps() {
    echo "üîç Comprobando dependencias del sistema y Python..."
    missing_sys=()
    missing_py=()

    # Comprobar pkg-config y webkit2gtk
    if ! command -v pkg-config >/dev/null 2>&1 || ! pkg-config --exists "webkit2gtk-4.0" 2>/dev/null; then
        missing_sys+=("libwebkit2gtk-4.1-0 libwebkit2gtk-4.1-dev")
    fi

    # Comprobar Qt WebEngine (paquetes del sistema / binding python)
    if ! python3 -c "import PyQt5.QtWebEngineWidgets" >/dev/null 2>&1; then
        missing_sys+=("python3-pyqt5 python3-pyqt5.qtwebengine libqt5webengine5")
        missing_py+=("PyQt5.QtWebEngineWidgets")
    fi

    # Comprobar gi (GTK) bindings
    if ! python3 -c "import gi" >/dev/null 2>&1; then
        missing_sys+=("python3-gi python3-gi-cairo gir1.2-gtk-3.0")
        missing_py+=("gi")
    fi

    # Comprobar pywebview disponible en python3
    if ! python3 -c "import webview" >/dev/null 2>&1; then
        missing_py+=("webview (pywebview)")
    fi
    
    # Comprobar qtpy (necesario para pywebview con Qt)
    if ! python3 -c "import qtpy" >/dev/null 2>&1; then
        missing_py+=("qtpy")
    fi

    # Archivos web fundamentales
    missing_files=()
    for f in "web/index.html" "web/js/main.js" "web/js/sectionsUI.js"; do
        if [ ! -f "$APP_DIR/$f" ]; then
            missing_files+=("$f")
        fi
    done

    if [ ${#missing_sys[@]} -ne 0 ] || [ ${#missing_py[@]} -ne 0 ] || [ ${#missing_files[@]} -ne 0 ]; then
        echo "\n[Diagnostics] Se detectaron elementos potencialmente faltantes:" 
        
        if [ ${#missing_sys[@]} -ne 0 ]; then
            echo "  - Paquetes del sistema sugeridos: ${missing_sys[*]}"
            echo "    ${YELLOW}Intentando instalar autom√°ticamente...${NC}"
            
            # Intentar instalar paquetes del sistema
            if sudo apt-get update -qq 2>/dev/null && sudo apt-get install -y -qq ${missing_sys[*]} 2>/dev/null; then
                echo -e "    ${GREEN}‚úÖ Paquetes instalados correctamente${NC}"
            else
                echo "    ${YELLOW}‚ö†Ô∏è  No se pudieron instalar todos los paquetes autom√°ticamente${NC}"
                echo "    Instala manualmente:"
                echo "      sudo apt update && sudo apt install -y ${missing_sys[*]}"
            fi
        fi
        
        if [ ${#missing_py[@]} -ne 0 ]; then
            echo "  - M√≥dulos Python ausentes o no detectados: ${missing_py[*]}"
            echo "    Ejecuta en el entorno del sistema o en el venv:"
            echo "      pip install ${missing_py[*]}"
        fi
        
        if [ ${#missing_files[@]} -ne 0 ]; then
            echo "  - Archivos web faltantes dentro de la instalaci√≥n: ${missing_files[*]}"
            echo "    Verifica que el directorio \$APP_DIR/web contenga los ficheros est√°ticos." 
        fi
        echo ""
    else
        echo "‚úÖ Dependencias m√≠nimas encontradas (comprobaci√≥n r√°pida)."
    fi
}

check_deps

# Si el venv no existe, crearlo (primera ejecuci√≥n)
if [ ! -d "$VENV_DIR" ]; then
    echo "üì¶ Primera ejecuci√≥n: creando entorno virtual..."
    
    # SIEMPRE instalar herramientas de compilaci√≥n (necesarias para webview y otras librer√≠as)
    echo "üîß Instalando herramientas de compilaci√≥n y dependencias..."
    sudo apt-get update -qq 2>/dev/null || true
    sudo apt-get install -y --no-install-recommends \
        python3-dev build-essential pkg-config \
        libgtk-3-dev libgtk-3-0 libcairo2-dev libcairo2 \
        python3-gi python3-gi-cairo gir1.2-gtk-3.0 \
        libwebkit2gtk-4.1-0 libwebkit2gtk-4.1-dev gir1.2-webkit2-4.1 \
        2>&1 | tail -5 || true
    
    # Crear venv con system-site-packages para acceder a python3-gi
    echo "üîß Creando venv con --system-site-packages..."
    python3 -m venv --system-site-packages "$VENV_DIR"
    
    # Actualizar pip/setuptools/wheel en el venv
    echo "‚¨ÜÔ∏è  Actualizando pip, setuptools, wheel..."
    "$PIP_VENV" install --upgrade pip setuptools wheel 2>&1 | tail -2 || true
    
    # Instalar requirements con preferencia por binarios precompilados
    if [ -f "$APP_DIR/requirements.txt" ]; then
        echo "üìö Instalando dependencias Python..."
        # Usar rutas est√°ndar de pkg-config
        export PKG_CONFIG_PATH="/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH:-}"
        "$PIP_VENV" install --prefer-binary -r "$APP_DIR/requirements.txt" 2>&1 | tail -5 || {
            echo "‚ö†Ô∏è  Problema en instalaci√≥n, intentando instalar componentes cr√≠ticos..."
            "$PIP_VENV" install --prefer-binary PyQt5 PyQtWebEngine qtpy pywebview bottle 2>&1 | tail -5 || {
                echo "‚ö†Ô∏è  Binarios no disponibles, intentando compilar..."
                "$PIP_VENV" install --no-binary :all: PyQt5 PyQtWebEngine qtpy pywebview bottle 2>&1 | tail -5 || true
            }
        }
        
        # Verificar componentes cr√≠ticos
        for mod in "bottle" "qtpy" "PyQt5"; do
            if ! "$PYTHON_VENV" -c "import $mod" 2>/dev/null; then
                echo "‚ö†Ô∏è  $mod no encontrado, reintentando instalaci√≥n..."
                "$PIP_VENV" install --prefer-binary --force-reinstall "$mod" 2>&1 | tail -2 || true
            fi
        done
    fi
    echo "‚úÖ Entorno virtual creado exitosamente"
fi

# Verificar que el venv est√° en buen estado
if [ ! -f "$PYTHON_VENV" ]; then
    echo "‚ùå Error: python3 no encontrado en venv"
    exit 1
fi

# Verificar que webview est√° instalado, si no lo est√°, instalarlo
if ! "$PYTHON_VENV" -c "import webview" 2>/dev/null; then
    echo "‚ö†Ô∏è  pywebview no encontrado, instalando..."
    export PKG_CONFIG_PATH="/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH:-}"
    
    # Intentar solo binarios primero
    "$PIP_VENV" install --only-binary :all: --force-reinstall pywebview 2>&1 | tail -3 || {
        # Si falla, intentar compilar
        "$PIP_VENV" install --no-binary pywebview --force-reinstall pywebview 2>&1 | tail -5 || {
            echo "‚ùå Error: No se pudo instalar pywebview"
            exit 1
        }
    }
fi

# Verificar que pywebview puede usar GTK (opcional, no bloquea)
if ! "$PYTHON_VENV" -c "import gi; gi.require_version('Gtk', '3.0'); from gi.repository import Gtk" 2>/dev/null; then
    echo "‚ö†Ô∏è  GTK/pywebview no totalmente disponible"
    echo "    Intenta: sudo apt install python3-gi python3-gi-cairo libgtk-3-dev libwebkit2gtk-4.1-dev"
fi

# Verificar que bottle est√° instalado (cr√≠tico para servidor web)
if ! "$PYTHON_VENV" -c "import bottle" 2>/dev/null; then
    echo "‚ö†Ô∏è  bottle no encontrado, intentando instalar..."
    "$PIP_VENV" install --prefer-binary bottle 2>&1 | tail -3 || true
fi

# Verificar que qtpy est√° instalado (cr√≠tico para Qt backend de pywebview)
if ! "$PYTHON_VENV" -c "import qtpy" 2>/dev/null; then
    echo "‚ö†Ô∏è  qtpy no encontrado, instalando..."
    "$PIP_VENV" install --prefer-binary qtpy 2>&1 | tail -3 || true
fi

# Verificar que PyQtWebEngine est√° instalado (backend de webview)
if ! "$PYTHON_VENV" -c "from PyQt5 import QtWebEngineWidgets" 2>/dev/null; then
    echo "‚ö†Ô∏è  PyQt5.QtWebEngineWidgets no encontrado, intentando instalar PyQtWebEngine..."
    "$PIP_VENV" install --prefer-binary PyQtWebEngine 2>&1 | tail -3 || true
fi

# Ejecutar aplicaci√≥n con el python del venv
cd "$APP_DIR"
exec "$PYTHON_VENV" "$MAIN_PY" "$@"
