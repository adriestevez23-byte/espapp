#!/bin/bash
set -e

# ============================================================================
# Lanzador ESPAPP - Se ejecuta al instalar el paquete
# Detecta/crea entorno virtual y lanza la aplicaci√≥n
# ============================================================================

APP_DIR="/opt/espapp"
VENV_DIR="/opt/espapp/.venv"
PYTHON_VENV="$VENV_DIR/bin/python3"
PIP_VENV="$VENV_DIR/bin/pip"
MAIN_PY="$APP_DIR/main.py"

if [ ! -f "$APP_DIR/main.py" ]; then
    echo "‚ùå Error: main.py no encontrado en $APP_DIR"
    exit 1
fi

# Si el venv no existe, crearlo (primera ejecuci√≥n)
if [ ! -d "$VENV_DIR" ]; then
    echo "üì¶ Primera ejecuci√≥n: creando entorno virtual..."
    
    # SIEMPRE instalar herramientas de compilaci√≥n (necesarias para webview y otras librer√≠as)
    echo "üîß Instalando herramientas de compilaci√≥n y dependencias..."
    sudo apt-get update -qq 2>/dev/null || true
    sudo apt-get install -y --no-install-recommends \
        python3-dev build-essential pkg-config \
        libgtk-3-dev libgtk-3-0 libcairo2-dev libcairo2 \
        python3-gi python3-gi-cairo gir1.2-gtk-3.0 \
        libwebkit2gtk-4.1-0 libwebkit2gtk-4.1-dev gir1.2-webkit2-4.1 \
        2>&1 | tail -5 || true
    
    # Crear venv con system-site-packages para acceder a python3-gi
    echo "üîß Creando venv con --system-site-packages..."
    python3 -m venv --system-site-packages "$VENV_DIR"
    
    # Actualizar pip/setuptools/wheel en el venv
    echo "‚¨ÜÔ∏è  Actualizando pip, setuptools, wheel..."
    "$PIP_VENV" install --upgrade pip setuptools wheel 2>&1 | tail -2 || true
    
    # Instalar requirements con preferencia por binarios precompilados
    if [ -f "$APP_DIR/requirements.txt" ]; then
        echo "üìö Instalando dependencias Python..."
        # Usar rutas est√°ndar de pkg-config
        export PKG_CONFIG_PATH="/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH:-}"
        "$PIP_VENV" install --prefer-binary -r "$APP_DIR/requirements.txt" 2>&1 | tail -5 || {
            echo "‚ö†Ô∏è  Problema en instalaci√≥n, intentando solo con pywebview y bottle..."
            "$PIP_VENV" install --only-binary :all: pywebview bottle 2>&1 | tail -3 || {
                echo "‚ö†Ô∏è  Binarios no disponibles, intentando compilar..."
                "$PIP_VENV" install --no-binary pywebview,bottle pywebview bottle 2>&1 | tail -3 || true
            }
        }
        
        # Verificar que bottle est√° instalado (cr√≠tico para modo web)
        if ! "$PYTHON_VENV" -c "import bottle" 2>/dev/null; then
            echo "‚ö†Ô∏è  bottle no encontrado, intentando instalar..."
            "$PIP_VENV" install --prefer-binary bottle 2>&1 | tail -3 || true
        fi
    fi
    echo "‚úÖ Entorno virtual creado exitosamente"
fi

# Verificar que el venv est√° en buen estado
if [ ! -f "$PYTHON_VENV" ]; then
    echo "‚ùå Error: python3 no encontrado en venv"
    exit 1
fi

# Verificar que webview est√° instalado, si no lo est√°, instalarlo
if ! "$PYTHON_VENV" -c "import webview" 2>/dev/null; then
    echo "‚ö†Ô∏è  pywebview no encontrado, instalando..."
    export PKG_CONFIG_PATH="/usr/lib/pkgconfig:/usr/share/pkgconfig:${PKG_CONFIG_PATH:-}"
    
    # Intentar solo binarios primero
    "$PIP_VENV" install --only-binary :all: --force-reinstall pywebview 2>&1 | tail -3 || {
        # Si falla, intentar compilar
        "$PIP_VENV" install --no-binary pywebview --force-reinstall pywebview 2>&1 | tail -5 || {
            echo "‚ùå Error: No se pudo instalar pywebview"
            exit 1
        }
    }
fi

# Verificar que pywebview puede usar GTK (opcional, no bloquea)
if ! "$PYTHON_VENV" -c "import gi; gi.require_version('Gtk', '3.0'); from gi.repository import Gtk" 2>/dev/null; then
    echo "‚ö†Ô∏è  GTK/pywebview no totalmente disponible"
    echo "    Intenta: sudo apt install python3-gi python3-gi-cairo libgtk-3-dev libwebkit2gtk-4.1-dev"
fi

# Verificar que bottle est√° instalado (cr√≠tico para servidor web)
if ! "$PYTHON_VENV" -c "import bottle" 2>/dev/null; then
    echo "‚ö†Ô∏è  bottle no encontrado, intentando instalar..."
    "$PIP_VENV" install --prefer-binary bottle 2>&1 | tail -3 || true
fi

# Ejecutar aplicaci√≥n con el python del venv
cd "$APP_DIR"
exec "$PYTHON_VENV" "$MAIN_PY" "$@"
